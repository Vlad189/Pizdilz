scripted_gui = {
	TE_peace_shield_ui = {
		window_name = "TE_request_peace_shield"
        context_type = selected_state_context
		parent_window_token = top_bar
		visible = {
			always = yes # shouldn't be available unles syou can actually declare war... 
		}
		
		effects = {
			TE_open_peace_request_btn_click = {
				set_variable = { ROOT.var_TE_show_surrender_gui = 1 } 
				#set_variable = { ROOT.var_TE_peace_neg_target = THIS } # test
				THIS.owner = { set_variable = { ROOT.var_TE_peace_neg_target = THIS } } # test
				IF = { 
					limit = {
						# check_variable = { ROOT.var_TE_war_type@THIS = 4 } # test
						THIS.owner = {  check_variable = { ROOT.var_TE_war_type@THIS = 4 } } # test
						#check_variable = { THIS.var_TE_war_type@ROOT = 6 } # test
						THIS.owner = { check_variable = { THIS.var_TE_war_type@ROOT = 6 } }# test
					}
					set_variable = { ROOT.war_type_check = 10 } # temp fix for independence / insurgence
				}
				ELSE = {
					# set_variable = { ROOT.war_type_check = ROOT.var_TE_war_type@THIS } # test
					THIS.owner = { set_variable = { ROOT.war_type_check = ROOT.var_TE_war_type@THIS } } # test
				}
			}
		  
        }  
		triggers = { 
			TE_open_peace_request_btn_click_enabled = {
				THIS.owner = { has_war_with = ROOT }
				# check_variable = { ROOT.var_TE_has_sent_offer@THIS = 0 } # test
				THIS.owner = { check_variable = { ROOT.var_TE_has_sent_offer@THIS = 0 } }# test
				#set_variable = { ROOT.var_TE_show_surrender_gui = 0 }
			}
            TE_open_peace_request_btn_visible = {
               #THIS = { has_war_with = ROOT }
			   ROOT = { has_war = yes }
            }
		}
		
		ai_enabled = {
            always = yes # Should be yes, but disabling for now
		}
		
		ai_test_interval = 68 
        ai_test_variance = 50    
		 
		ai_test_scopes = test_enemy_owned_states
        
        ai_check = {
			check_variable = { var_TE_show_surrender_gui = 0 } 
			has_war = yes
			# check_variable = { ROOT.var_TE_has_sent_offer@THIS = 0 } # test
			THIS.owner = { check_variable = { ROOT.var_TE_has_sent_offer@THIS = 0 } }# test
			#NOT = { check_variable = { ROOT.var_TE_war_type@THIS = 4 } } # test # Don't even think about it in a civil war (if opponent has ind war, yes - but that is dealt with separately
			NOT = { THIS.owner = { check_variable = { ROOT.var_TE_war_type@THIS = 4 } } } # test # Don't even think about it in a civil war (if opponent has ind war, yes - but that is dealt with separately
			#surrender_progress > 0.14
			#check_variable = { ai_random < 0.5 }
			#check_variable = { ai_random < var_faith_in_lon }
			#check_variable = { var_faith_in_lon > 0.24 }
        }
        
       
		
		ai_weights = {
			TE_open_peace_request_btn_click = {
				ai_will_do = {
					factor = 1
					modifier = {
						factor = 0
						ROOT = {
							has_government = fascism
							is_major = yes 
						}
					}
				}
			}
		}
	}
	
	
	#### REPLACEMENT GUI FOR requesting peace
	#### Main variables used for peace process communication
	# VICTOR.var_TE_peace_offer_available@LOSER = 0/1 - unlocks country selection GUI 
	# LOSER.var_TE_has_sent_offer@VICTOR = 0/1 - Conditional peace only - so that you cant sent the same offer twice. 
	# VICTOR.var_TE_has_started_treaty@LOSER = 0/1 - Set to 1 when clicking the button in this GUI 
	# VICTOR.var_TE_has_sent_treaty@LOSER = 0/1 - set to 1 when "DONE" with peace treaty, used to complete mission timer and kick off peace. 
	# VICTOR.var_TE_number_peace_offers_accepted = x # Counter, can be used to show how many peace treaties the player needs to work with
		
	TE_peace_offer_send_ui = {
		window_name = "TE_request_peace_window"
        #context_type = selected_state_context
		
		visible = {
			check_variable = { var_TE_show_surrender_gui = 1 } 
			#has_war_with = ROOT
			
			#surrender_progress > 0.15
			#any_owned_state = {
			#	NOT = { is_controlled_by = ROOT }
			#}
		}
		
		effects = {
			TE_close_peace_req_btn_click = {
				set_variable = { var_TE_show_surrender_gui = 0 } 
			
			}
		
		
		
			TE_offer_conditional_surrender_btn_click = {			
				IF = { 
					limit = { ROOT = { has_active_mission = TE_peace_offer_sent } }			
					set_temp_variable = { temp_time = global.var_TE_peace_timer_days }
					subtract_from_temp_variable = { temp_time = days_mission_timeout@TE_peace_offer_sent }
					ROOT = { 
						add_days_mission_timeout = { 
							mission = TE_peace_offer_sent days = temp_time 
						} 
					}
				}
				ELSE = {
					ROOT = { activate_mission = TE_peace_offer_sent }
				}
				set_variable = { ROOT.var_TE_has_sent_offer@var:var_TE_peace_neg_target = 1 }
				var:var_TE_peace_neg_target = { set_variable = { var_TE_peace_type@ROOT = 1 } }
				set_temp_variable  = { temp_political_cost = global.var_TE_conditional_pp }
				multiply_temp_variable = { temp_political_cost = -1 }
				add_political_power = temp_political_cost
				var:var_TE_peace_neg_target = { 
					country_event = { 
						id = TE_peace_event.1
						days = 1
					}
				}
				set_variable = { var_TE_show_surrender_gui = 0 } # close
            }
			TE_offer_unconditional_surrender_btn_click = {
				IF = { 
					limit = { ROOT = { has_active_mission = TE_peace_offer_sent } }
					set_temp_variable = { temp_time = global.var_TE_peace_timer_days }
					subtract_from_temp_variable = { temp_time = days_mission_timeout@TE_peace_offer_sent }
					ROOT = { 
						add_days_mission_timeout = { 
							mission = TE_peace_offer_sent days = temp_time 
						} 
					}
				}
				ELSE = {
					ROOT = { activate_mission = TE_peace_offer_sent }
				}
				set_variable = { ROOT.var_TE_has_sent_offer@var:var_TE_peace_neg_target = 1 }
				var:var_TE_peace_neg_target = { set_variable = { var_TE_peace_type@ROOT = 2 } }
				set_temp_variable  = { temp_political_cost = global.var_TE_unconditional_pp }
				multiply_temp_variable = { temp_political_cost = -1 }
				add_political_power = temp_political_cost
				var:var_TE_peace_neg_target = { 
					country_event = { 
						id = TE_peace_event.22
						days = 1
					}
				}
				set_variable = { var_TE_show_surrender_gui = 0 } # close
            }
			TE_offer_recognition_btn_click = {
				IF = { 
					limit = { ROOT = { has_active_mission = TE_peace_offer_sent } }
					set_temp_variable = { temp_time = global.var_TE_peace_timer_days }
					subtract_from_temp_variable = { temp_time = days_mission_timeout@TE_peace_offer_sent }
					ROOT = { 
						add_days_mission_timeout = { 
							mission = TE_peace_offer_sent days = temp_time 
						} 
					}
				}
				ELSE = {
					ROOT = { activate_mission = TE_peace_offer_sent }
				}
				set_variable = { ROOT.var_TE_has_sent_offer@var:var_TE_peace_neg_target = 1 }
				var:var_TE_peace_neg_target = { set_variable = { var_TE_peace_type@ROOT = 3 } }
				set_temp_variable  = { temp_political_cost = global.var_TE_recognition_pp }
				multiply_temp_variable = { temp_political_cost = -1 }
				add_political_power = temp_political_cost
				var:var_TE_peace_neg_target = { 
					country_event = { 
						id = TE_peace_event.8
						days = 1
					}
				}
				set_variable = { var_TE_show_surrender_gui = 0 } # close
            }
			TE_offer_white_peace_btn_click = {
				set_temp_variable  = { temp_political_cost = global.var_TE_white_pp }
				multiply_temp_variable = { temp_political_cost = -1 }
				add_political_power = temp_political_cost
				var:var_TE_peace_neg_target = { 
					country_event = { 
						id = TE_peace_event.13
						days = 1
					}
				}
				set_variable = { var_TE_show_surrender_gui = 0 } # close
			}
			
			TE_offer_mild_terms_btn_click = {
				set_temp_variable  = { temp_political_cost = global.var_TE_mild_terms_pp }
				multiply_temp_variable = { temp_political_cost = -1 }
				add_political_power = temp_political_cost
				var:var_TE_peace_neg_target = { 
					country_event = { 
						id = TE_peace_event.25
						hours = 1
					}
				}
				set_variable = { var_TE_show_surrender_gui = 0 } # close
			
			}
			
           		
        }
		triggers =  {
			TE_offer_conditional_surrender_btn_click_enabled = {
				var:var_TE_peace_neg_target = { 
					has_war_with = ROOT
					NOT = { is_subject = yes }
					NOT = { is_puppet = yes }
				}
				OR = {
					ROOT = { surrender_progress > 0.01 }
					check_variable = { ROOT.WarExhaustion > 100 }
				}
				ROOT = { surrender_progress < 0.65 }
				var:var_TE_peace_neg_target = {
					any_state = { 
						is_controlled_by = PREV 
						OR = {
							is_owned_by = ROOT 
							any_country = {
								is_puppet_of = ROOT
								PREV = { is_owned_by = PREV }
							}
						}
					}
				}	
				ROOT = { has_political_power > var:global.var_TE_conditional_pp }	
				OR = {
					var:var_TE_peace_neg_target = { is_in_faction = no }
					var:var_TE_peace_neg_target = { is_faction_leader = yes }
					any_country = {
						is_in_faction_with = var:var_TE_peace_neg_target
						is_faction_leader = yes
						NOT = { has_war_with = ROOT }
					}
				}
				OR = {
					ROOT = { is_in_faction = no }
					ROOT = { is_faction_leader = yes }
					NOT = { 
						any_country = {
							is_in_faction_with = ROOT 
							has_war_with =  var:var_TE_peace_neg_target
						}
					}
				}
				NOT = { 
					OR = {
						has_civil_war = yes 
						var:var_TE_peace_neg_target = { check_variable = { THIS.var_TE_war_type@ROOT = 4 } }
					}
				}
				
			}
			
			TE_offer_unconditional_surrender_btn_click_enabled = {
				var:var_TE_peace_neg_target = { 
					has_war_with = ROOT
					NOT = { is_subject = yes }
					NOT = { is_puppet = yes }
				}
				ROOT = { surrender_progress > 0.65 }
				# ROOT = { surrender_progress < 0.95 } # What happens if we remove this? 
				ROOT = { has_political_power > var:global.var_TE_unconditional_pp }
				var:var_TE_peace_neg_target = {
					any_state = { 
						is_controlled_by = PREV 
						is_owned_by = ROOT 
					}
				}
				OR = {
					var:var_TE_peace_neg_target = { is_in_faction = no }
					var:var_TE_peace_neg_target = { is_faction_leader = yes }
					any_country = {
						is_in_faction_with = var:var_TE_peace_neg_target
						is_faction_leader = yes
						NOT = { has_war_with = ROOT }
					}
				}
				NOT = { 
					OR = {
						has_civil_war = yes 
						var:var_TE_peace_neg_target = { check_variable = { THIS.var_TE_war_type@ROOT = 4 } }
					}
				}
				
			}
			
			TE_offer_recognition_btn_click_enabled = {
				var:var_TE_peace_neg_target = { 
					has_war_with = ROOT
					NOT = { is_subject = yes }
					NOT = { is_puppet = yes }
					check_variable = { THIS.var_TE_war_type@ROOT = 6 }
				}
				NOT = {
					var:var_TE_peace_neg_target= {
						any_country = {
							is_in_faction_with = PREV
							check_variable = { THIS.var_TE_war_type@ROOT = 4 }
						}
					}
				}
				
				ROOT = { has_political_power > var:global.var_TE_recognition_pp } 	
			
				 
			}
			
			TE_offer_white_peace_btn_click_enabled = {
				#always = no # for disabling
				var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 5 } } 
				ROOT = { has_political_power > var:global.var_TE_white_pp }
				var:var_TE_peace_neg_target = { 
					has_war_with = ROOT
					NOT = { is_subject = yes }
					NOT = { is_puppet = yes }
				}
				ROOT = { surrender_progress < 0.02 }
				var:var_TE_peace_neg_target = {
					NOT = {
						any_state = { 
							is_controlled_by = PREV 
							is_owned_by = ROOT 
						}
					}
					NOT = {
						any_state = {
							is_controlled_by = ROOT
							is_owned_by = PREV  
						}
					}
				}
				ROOT = {
					OR = {
						is_in_faction = no
						is_faction_leader = yes 
						any_country = {
							is_in_faction_with = ROOT 
							is_faction_leader = yes 
							NOT = { has_war_with = var:var_TE_peace_neg_target }
						}
					}
				}
			}
			
			TE_offer_mild_terms_btn_click_enabled = {
				# at least 3 months
				var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 2 } }
				# NOT a puppet
				var:var_TE_peace_neg_target = { 
					has_war_with = ROOT
					NOT = { is_subject = yes }
					NOT = { is_puppet = yes }
				}
				# target must be losing
				OR = { 
					var:var_TE_peace_neg_target = { surrender_progress > 0.01 }
					any_country = {
						is_puppet_of = var:ROOT.var_TE_peace_neg_target
						has_war_with = ROOT 
						surrender_progress > 0.01  
					}
				} 
						
				# We control one of their states or a puppet's state
				var:ROOT.var_TE_peace_neg_target = {
					any_state = { 
						OR = {
							is_controlled_by = ROOT 
							any_country = {
								is_in_faction_with = ROOT 
								controls_state = PREV 
							}
						}
						OR = {
							is_owned_by = PREV 
							any_country = {
								OR = {
									is_puppet_of = var:ROOT.var_TE_peace_neg_target
									is_subject_of = var:ROOT.var_TE_peace_neg_target
								}
								PREV = { is_owned_by = PREV }
							}
						}
					}
				}	
				# enough PP
				ROOT = { has_political_power > var:global.var_TE_mild_terms_pp }	
				# Target is Faction Leader or we are not in war with FL
				OR = {
					var:var_TE_peace_neg_target = { is_in_faction = no }
					var:var_TE_peace_neg_target = { is_faction_leader = yes }
					any_country = {
						is_in_faction_with = var:var_TE_peace_neg_target
						is_faction_leader = yes
						NOT = { has_war_with = ROOT }
					}
				}
				# We are Faction leader or FL not at war with target
				OR = {
					ROOT = { is_in_faction = no }
					ROOT = { is_faction_leader = yes }
					NOT = { 
						any_country = {
							is_in_faction_with = ROOT 
							has_war_with =  var:var_TE_peace_neg_target
						}
					}
				}
				# Not in a civil war 
				NOT = { 
					OR = {
						has_civil_war = yes 
						var:var_TE_peace_neg_target = { check_variable = { THIS.var_TE_war_type@ROOT = 4 } }
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_type@THIS = 4 } }
					}
				}
				
			}
		}
		
		
		
		#### Testing to see if I can get the AI to work for requesting peace
		ai_enabled = {
            always = yes
		}
		
		ai_test_interval = 68 
        ai_test_variance = 50    
		 
		ai_test_scopes = test_enemy_countries
        
        ai_check = {
			check_variable = { var_TE_show_surrender_gui = 1 } 
			has_war = yes
			check_variable = { ROOT.var_TE_has_sent_offer@THIS = 0 }
			#ROOT = { surrender_progress > 0.05 }
			#check_variable = { ai_random < 0.5 }
			#check_variable = { ai_random < var_faith_in_lon }
			#check_variable = { var_faith_in_lon > 0.24 }
        }
        
       
		
		ai_weights = {
			TE_offer_conditional_surrender_btn_click = {
				ai_will_do = {
					factor = 0.8
					modifier = {
						factor = 0
						ROOT = {
							has_government = fascism
							is_major = yes 
						}
					}
				}
			}
			
			TE_offer_unconditional_surrender_btn_click  = {
				ai_will_do = {
					base = 1
					
					modifier = {
						factor = 1.25
						ROOT = {
							#NOT = { has_government = fascism }
							NOT = {is_major = yes  }
						}
					}
					modifier = {
						factor = 0
						check_variable = { ai_random < 0.5 }
					}
					modifier = {
						factor = 0
						var:var_TE_peace_neg_target = { check_variable = { THIS.var_TE_war_type@ROOT = 4 } }
					}
				}
			
			}
			
			TE_close_peace_req_btn_click = {
				ai_will_do = {
					factor = 0.5
				}
			}
			TE_offer_recognition_btn_click = {
				ai_will_do = {
					factor = 1
					modifier = {
						factor = 0
						check_variable = { ai_random < 0.5 }
					}
					modifier = {
						factor = 0.25
						check_variable = { ROOT.WarExhaustion < 50 }
					}
					modifier = {
						factor = 1.25
						check_variable = { ROOT.WarExhaustion > 150 }
					}
					modifier = {
						factor = 1.5
						check_variable = { ROOT.WarExhaustion > 250 }
					}
				}
			}
			
			TE_offer_mild_terms_btn_click = {
				ai_will_do = {
					base = 0
					modifier = {
						add = 0.1
						check_variable = { ROOT.WarExhaustion > 50 }
					}
					modifier = {
						add = 0.1
						check_variable = { ROOT.WarExhaustion > 150 }
					}
					modifier = {
						add = 0.15
						threat < 0.15
					}
					modifier = {
						add = 0.1
						any_state = {
							is_owned_by = var:var_TE_peace_neg_target 
							is_controlled_by = ROOT 
							
						}
					}
					modifier = {
						add = 0.1
						any_state = {
							is_owned_by = var:var_TE_peace_neg_target 
							is_controlled_by = ROOT 
							is_claimed_by = ROOT 
						}
					}
					modifier = {
						add = 0.2
						any_state = {
							is_owned_by = var:var_TE_peace_neg_target 
							is_controlled_by = ROOT 
							is_core_of = ROOT 
						}
					}
					modifier = {
						add = 0.15
						AND = {
							any_state = {
								is_owned_by = var:var_TE_peace_neg_target 
								is_controlled_by = ROOT 
							}
							NOT = {
								any_state = {
									is_owned_by = var:var_TE_peace_neg_target 
									is_claimed_by = ROOT 
									is_controlled_by = var:var_TE_peace_neg_target 
								}
							}
						}
					}
					
					
					modifier = {
						add = 0.1
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 2 } }
					}
					modifier = {
						add = 0.1
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 6 } }
					}
					modifier = {
						add = 0.1
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 12 } }
					}
					modifier = {
						add = 0.15
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 24 } }  
					}
					modifier = {
						add = 0.2
						var:var_TE_peace_neg_target = { check_variable = { ROOT.var_TE_war_length@THIS > 36 } }
					}
					modifier = {
						add = 0.25
						any_country = {
							has_war_with = ROOT 
							NOT = { is_in_faction_with = var:var_TE_peace_neg_target }
							is_major = yes 
						}
					}
					modifier = {
						add = 0.15
						any_country = {
							has_war_with = ROOT 
							NOT = { is_in_faction_with = var:var_TE_peace_neg_target }
							is_major = no 
						}
					}
					modifier = {
						add = 0.25
						and = {
							has_government = democratic
							var:var_TE_peace_neg_target = { NOT = { has_government = fascism } }
						}
					}
					modifier = {
						factor = 0.5
						has_government = fascism 
					}
					modifier = {
						factor = 0.75
						is_major = yes 
					}
					modifier = {
						factor = 0.25
						var:var_TE_peace_neg_target = {has_government = fascism } 
					}
					modifier = {
						factor = 1.5
						var:var_TE_peace_neg_target = { 
							OR = {
								check_variable = { ROOT.var_TE_war_type@THIS = 1 } 
								check_variable = { ROOT.var_TE_war_type@THIS = 2 } 
								#check_variable = { ROOT.var_TE_war_type@THIS = 7 } 
							}
						}
					}
					modifier = {
						factor = 1.1
						var:var_TE_peace_neg_target = { 
							OR = {
								#check_variable = { ROOT.var_TE_war_type@THIS = 1 } 
								#check_variable = { ROOT.var_TE_war_type@THIS = 2 } 
								check_variable = { ROOT.var_TE_war_type@THIS = 7 } 
							}
						}
					}
				
				}
			
			}
			
			
		}
		
	}
	
	
}